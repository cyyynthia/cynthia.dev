---
// Component originally written by Mary
// https://codeberg.org/mary-ext/astro-bluesky-post/src/branch/trunk/src/components/BlueskyPost.astro

import * as core from 'bluesky-post-embed/core'
import stylesUrl from 'bluesky-post-embed/style.css?url'

interface Props {
	src: string;
	contextLess?: boolean;
}

const { src, contextLess = false } = Astro.props

const data = await core.get(src, contextLess)
const template = core.render(data, contextLess)
---
<bluesky-post src={src} theme="light">
	<template shadowrootmode="open">
		<link rel="stylesheet" href={stylesUrl} />
		<Fragment set:html={template.value} />
	</template>
</bluesky-post>

<script>
	import 'bluesky-post-embed'

	const dark = matchMedia('(prefers-color-scheme: dark)')
	const updateTheme = () => {
		const isDark = dark.matches
		for (const node of document.querySelectorAll('bluesky-post')) {
			node.setAttribute('theme', !isDark ? 'light' : 'dark')
		}
	}

	document.addEventListener('astro:after-swap', updateTheme)
	dark.addEventListener('change', updateTheme)
	updateTheme()
</script>
